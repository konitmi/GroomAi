<!DOCTYPE html>
<html>
<head>
  <title>GroomAI ‚Äì Best Hairstyle Match</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f8f8f8; padding: 20px; }
    h1 { color: #222; }
    input { margin-top: 20px; }
    #result, #suggestion, #debug { margin-top: 20px; font-size: 1.1rem; font-weight: bold; }
    img { max-width: 300px; border-radius: 10px; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>üíá GroomAI</h1>
  <input type="file" id="imageUpload" accept="image/*">
  <div id="result">Upload your selfie to find your best hairstyle match!</div>
  <div id="suggestion"></div>
  <div id="debug" style="color:red;"></div>
  <div id="imageContainer"></div>

  <!-- ‚úÖ Correct script placement -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    const debug = msg => {
      document.getElementById('debug').innerText = msg;
      console.log(msg);
    };

    async function detectFace() {
      try {
        const input = document.getElementById('imageUpload');
        if (!input.files[0]) return;

        const img = await faceapi.bufferToImage(input.files[0]);
        document.getElementById('imageContainer').innerHTML = "";
        document.getElementById('imageContainer').append(img);

        const detection = await faceapi.detectSingleFace(img).withFaceLandmarks();
        if (!detection) {
          document.getElementById('result').innerText = "‚ùå Face not detected. Try a better selfie.";
          return;
        }

        const points = detection.landmarks.positions;
        const jaw = distance(points[4], points[12]);
        const forehead = distance(points[19], points[24]);
        const height = distance(points[8], points[27]);

        const shape = classify(jaw, forehead, height);
        document.getElementById('result').innerText = `‚úÖ Face Shape: ${shape}`;
        document.getElementById('suggestion').innerText = getStyle(shape);
      } catch (err) {
        debug("‚ùå Error: " + err.message);
      }
    }

    function distance(p1, p2) {
      return Math.hypot(p1.x - p2.x, p1.y - p2.y);
    }

    function classify(jaw, fore, h) {
      const r = fore / jaw;
      const hr = h / jaw;
      if (r > 1.05 && hr > 1.4) return "Long";
      if (r < 0.9) return "Heart";
      if (Math.abs(r - 1) < 0.1 && hr > 1.5) return "Oval";
      if (Math.abs(jaw - fore) < 20 && hr < 1.5) return "Square";
      return "Round";
    }

    function getStyle(shape) {
      return {
        "Oval": "Pompadour, Quiff, or Slick Back",
        "Round": "High Fade, Angular Fringe",
        "Square": "Buzz Cut, Crew Cut",
        "Heart": "Side Part, Medium Fringe",
        "Long": "Flowy Layers, Side Swept"
      }[shape] || "Try a clearer image.";
    }

    document.getElementById('imageUpload').addEventListener('change', async () => {
      try {
        debug("üß† Loading models...");
        await faceapi.nets.ssdMobilenetv1.loadFromUri('https://groomaimodels.netlify.app/models');
        await faceapi.nets.faceLandmark68Net.loadFromUri('https://groomaimodels.netlify.app/models');
        debug("‚úÖ Models loaded.");
        detectFace();
      } catch (e) {
        debug("‚ùå Failed to load models: " + e.message);
      }
    });
  </script>
</body>
</html>
